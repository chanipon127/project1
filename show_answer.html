<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</title>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Sarabun', Arial, sans-serif; margin: 0; display: flex; background: #f5f7fa; }
    nav.sidebar { width: 220px; background: #333; color: #fff; min-height: 100vh; padding: 20px; }
    nav.sidebar h2 { font-size: 20px; margin-bottom: 20px; }
    nav.sidebar a { display: block; color: #fff; text-decoration: none; margin-bottom: 10px; padding: 10px; background: #444; border-radius: 5px; }
    nav.sidebar a:hover { background: #555; }

    main.content { flex: 1; padding: 20px; overflow-x: auto; }
    h1 { text-align: center; margin-bottom: 20px; }

    .filters {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
      justify-content: center;
    }

    select, input {
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-family: 'Sarabun', sans-serif;
    }

    button {
      padding: 8px 16px;
      border: none;
      background: #3b5bdb;
      color: #fff;
      border-radius: 5px;
      cursor: pointer;
    }

    button:hover {
      opacity: 0.9;
    }

    table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; }
    th, td { padding: 10px; border-bottom: 1px solid #ddd; text-align: left; }
    th { background: #3b5bdb; color: white; }

    .pagination {
      margin-top: 20px;
      text-align: center;
    }

    .pagination button {
      margin: 2px;
      background: #eee;
      color: #333;
      border: 1px solid #ccc;
    }

    .pagination button.active {
      background: #3b5bdb;
      color: white;
    }

    @media (max-width: 768px) {
      nav.sidebar { width: 100px; }
      nav.sidebar h2 { font-size: 16px; }
      nav.sidebar a { font-size: 14px; padding: 5px; }
    }
  </style>
</head>
<body>

  <nav class="sidebar">
    <h2>‡πÄ‡∏°‡∏ô‡∏π</h2>
    <a href="homepage_admin.html">HOME PAGE</a>
    <a href="manage_user.html">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</a>
    <a href="create_answer.html">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</a>
    <a href="show_answer.html">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</a>
    <a href="view_feedback.html">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</a>
    <a href="settings.html">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</a>
    <a href="login.html">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a>
  </nav>

  <main class="content">
    <h1>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h1>

    <!-- üîπ ‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ -->
    <div class="filters">
      <select id="yearSelect">
        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö --</option>
      </select>

      <select id="groupSelect">
        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô --</option>
      </select>

      <input type="text" id="studentInput" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ)">
      <button id="filterBtn">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
      <button id="resetBtn" style="background:#999;">‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤</button>
    </div>

    <table id="answersTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
          <th>‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö</th>
          <th>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
          <th>‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà 1</th>
          <th>‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà 2</th>
          <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="7" style="text-align:center; color:#888;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>
      </tbody>
    </table>

    <div class="pagination" id="pagination"></div>
  </main>

<script>
const API_BASE = 'http://127.0.0.1:8000';
const tableBody = document.querySelector('#answersTable tbody');
const pagination = document.getElementById('pagination');
const yearSelect = document.getElementById('yearSelect');
const groupSelect = document.getElementById('groupSelect');
const studentInput = document.getElementById('studentInput');
const filterBtn = document.getElementById('filterBtn');
const resetBtn = document.getElementById('resetBtn');

let allAnswers = [];
let filteredAnswers = [];
let currentPage = 1;
const itemsPerPage = 50;

// ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡∏à‡∏≤‡∏Å API
async function loadExamYears() {
  try {
    const res = await fetch(`${API_BASE}/exam_years`);
    const years = await res.json();
    years.forEach(y => {
      const opt = document.createElement('option');
      opt.value = y;
      opt.textContent = y;
      yearSelect.appendChild(opt);
    });
  } catch (err) {
    console.error('‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', err);
  }
}

// ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡∏à‡∏≤‡∏Å API
async function loadGroups() {
  try {
    const res = await fetch(`${API_BASE}/group_ids`);
    const groups = await res.json();
    groups.forEach(g => {
      const opt = document.createElement('option');
      opt.value = g;
      opt.textContent = g;
      groupSelect.appendChild(opt);
    });
  } catch (err) {
    console.error('‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', err);
  }
}

// ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
async function loadAnswers() {
  try {
    const res = await fetch(`${API_BASE}/api/answers-all`);
    if (!res.ok) throw new Error(`Error ${res.status}`);
    allAnswers = await res.json();
    filteredAnswers = allAnswers;
    currentPage = 1;
    renderTable();
  } catch (err) {
    console.error('loadAnswers error:', err);
    tableBody.innerHTML = `<tr><td colspan="7" style="text-align:center; color:red;">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö: ${err.message}</td></tr>`;
  }
}

// ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏ö‡πà‡∏á‡∏´‡∏ô‡πâ‡∏≤
function renderTable() {
  tableBody.innerHTML = '';
  if (filteredAnswers.length === 0) {
    tableBody.innerHTML = `<tr><td colspan="7" style="text-align:center; color:#888;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</td></tr>`;
    pagination.innerHTML = '';
    return;
  }

  const start = (currentPage - 1) * itemsPerPage;
  const end = start + itemsPerPage;
  const pageData = filteredAnswers.slice(start, end);

  pageData.forEach(ans => {
    const row = `<tr>
      <td>${ans.answer_id}</td>
      <td>${ans.student_id}</td>
      <td>${ans.exam_year}</td>
      <td>${ans.group_id}</td>
      <td>${ans.essay_text}</td>
      <td>${ans.essay_analysis}</td>
      <td>${ans.status}</td>
    </tr>`;
    tableBody.innerHTML += row;
  });

  renderPagination();
}

// ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏ö‡πà‡∏á‡∏´‡∏ô‡πâ‡∏≤
function renderPagination() {
  const totalPages = Math.ceil(filteredAnswers.length / itemsPerPage);
  pagination.innerHTML = '';

  if (totalPages <= 1) return;

  const prevBtn = document.createElement('button');
  prevBtn.textContent = '¬´ ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤';
  prevBtn.disabled = currentPage === 1;
  prevBtn.onclick = () => { currentPage--; renderTable(); };
  pagination.appendChild(prevBtn);

  for (let i = 1; i <= totalPages; i++) {
    const btn = document.createElement('button');
    btn.textContent = i;
    if (i === currentPage) btn.classList.add('active');
    btn.onclick = () => { currentPage = i; renderTable(); };
    pagination.appendChild(btn);
  }

  const nextBtn = document.createElement('button');
  nextBtn.textContent = '‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ¬ª';
  nextBtn.disabled = currentPage === totalPages;
  nextBtn.onclick = () => { currentPage++; renderTable(); };
  pagination.appendChild(nextBtn);
}

// ‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
function filterAnswers() {
  const year = yearSelect.value;
  const group = groupSelect.value;
  const student = studentInput.value.trim();

  filteredAnswers = allAnswers.filter(a => {
    return (!year || a.exam_year == year) &&
           (!group || a.group_id == group) &&
           (!student || a.student_id.toString().includes(student));
  });

  currentPage = 1;
  renderTable();
}

// ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î
filterBtn.addEventListener('click', filterAnswers);
resetBtn.addEventListener('click', () => {
  yearSelect.value = '';
  groupSelect.value = '';
  studentInput.value = '';
  filteredAnswers = allAnswers;
  currentPage = 1;
  renderTable();
});

// ‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ï‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°
window.addEventListener('DOMContentLoaded', () => {
  loadExamYears();
  loadGroups();
  loadAnswers();
});
</script>

</body>
</html>
