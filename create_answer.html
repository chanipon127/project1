<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</title>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Sarabun', Arial, sans-serif;
      margin: 0;
      display: flex;
      background: #f5f7fa;
    }

    nav.sidebar {
      width: 220px;
      background: #333;
      color: #fff;
      min-height: 100vh;
      padding: 20px;
    }

    nav.sidebar a {
      display: block;
      color: #fff;
      text-decoration: none;
      margin-bottom: 10px;
      padding: 10px;
      background: #444;
      border-radius: 5px;
    }

    nav.sidebar a:hover {
      background: #555;
    }

    main.content {
      flex: 1;
      padding: 20px;
      overflow-x: auto;
    }

    .form-container {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    h1,
    h2 {
      text-align: center;
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }

    input,
    textarea,
    select {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
    }

    .score-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    .score-table th,
    .score-table td {
      border: 1px solid #ccc;
      padding: 5px;
      text-align: center;
    }

    button {
      margin-top: 20px;
      width: 100%;
      background-color: #3b5bdb;
      color: white;
      padding: 10px;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      transition: opacity 0.3s;
    }

    button:hover {
      opacity: 0.8;
    }

    /* üé® ‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î */
    .mode-options {
      display: flex;
      gap: 20px;
      justify-content: center;
      margin-top: 20px;
    }

    .mode-card {
      flex: 1;
      background: #f8f9fa;
      border: 2px solid #ddd;
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
    }

    .mode-card:hover {
      border-color: #3b5bdb;
      background: #eef2ff;
    }

    .mode-card.active {
      border-color: #3b5bdb;
      background: #dbe4ff;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>

<body>
  <nav class="sidebar">
    <h2>‡πÄ‡∏°‡∏ô‡∏π</h2>
    <a href="homepage_admin.html">HOME PAGE</a>
    <a href="manage_user.html">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</a>
    <a href="create_answer.html">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</a>
    <a href="show_answer.html">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</a>
    <a href="view_feedback.html">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</a>
    <a href="login.html">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a>
  </nav>

  <main class="content">
    <div class="form-container">
      <h1>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h1>
      <p style="text-align:center; font-weight:bold;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</p>
      <div class="mode-options">
        <div class="mode-card" data-mode="manual">
          <h3>üìù ‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á</h3>
          <p>‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡∏•‡∏∞‡∏Ñ‡∏ô ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏™‡πà‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏£‡∏π</p>
        </div>
        <div class="mode-card" data-mode="upload">
          <h3>üìÇ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå</h3>
          <p>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î CSV/Excel ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
        </div>
      </div>
    </div>

    <!-- ‚úÖ Form ‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á -->
    <div class="form-container" id="manualForm" style="display:none;">
      <h2>‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
      <form id="answerForm">
        <label>‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
        <input type="number" name="student_id" required>

        <label>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
        <select name="group_id" required>
          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
          <option value="P6">‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 6</option>
          <option value="M3">‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 3</option>
        </select>

        <label>‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö</label>
        <input type="number" name="exam_year" required>

        <label>‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà 1</label>
        <textarea name="essay_text" rows="3" required></textarea>

        <label>‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà 2</label>
        <textarea name="essay_analysis" rows="3" required></textarea>

        <h3>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à</h3>
        <table class="score-table">
          <thead>
            <tr>
              <th>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</th>
              <th>‡∏Ñ‡∏£‡∏π‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà 1</th>
              <th>‡∏Ñ‡∏£‡∏π‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà 2</th>
            </tr>
          </thead>
          <tbody id="scoreTableBody"></tbody>
        </table>

        <button type="submit">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
      </form>
      <p id="messageForm" style="margin-top:10px;"></p>
    </div>

    <!-- ‚úÖ Form ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå -->
    <div class="form-container" id="uploadFormBox" style="display:none;">
      <h2>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå</h2>
      <form id="uploadForm" enctype="multipart/form-data">
        <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå (CSV ‡∏´‡∏£‡∏∑‡∏≠ Excel)</label>
        <input type="file" name="file" accept=".csv,.xlsx" required>
        <button type="submit">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå</button>
      </form>
      <p id="messageUpload" style="margin-top:10px;"></p>
      <p style="color: gray; font-size: 14px;">
        - ‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô <b>.csv</b> ‡∏´‡∏£‡∏∑‡∏≠ <b>.xlsx</b><br>
        - ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå: <b>student_id, group_id, exam_year, essay_text, essay_analysis</b><br>
        (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏™‡πà <b>s1_t1 - s13_t2</b> ‡πÑ‡∏î‡πâ‡∏î‡πâ‡∏ß‡∏¢)
      </p>
    </div>
  </main>

  <script>
    const API_BASE = 'http://127.0.0.1:8000';

    // ‚úÖ ‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πå‡∏î
    const modeCards = document.querySelectorAll('.mode-card');
    const manualForm = document.getElementById('manualForm');
    const uploadFormBox = document.getElementById('uploadFormBox');

    modeCards.forEach(card => {
      card.addEventListener('click', () => {
        modeCards.forEach(c => c.classList.remove('active'));
        card.classList.add('active');

        const mode = card.getAttribute('data-mode');
        manualForm.style.display = mode === 'manual' ? 'block' : 'none';
        uploadFormBox.style.display = mode === 'upload' ? 'block' : 'none';
      });
    });

    // ‚úÖ Mapping ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
    const scoreMapping = {
      "s1": "‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà 1 - ‡πÉ‡∏à‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç (4 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)",
      "s2": "‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà 1 - ‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î (2 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)",
      "s3": "‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà 1 - ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏¢‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (1 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)",
      "s4": "‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà 1 - ‡∏Å‡∏≤‡∏£‡∏™‡∏∞‡∏Å‡∏î‡∏Ñ‡∏≥ (1 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)",
      "s5": "‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà 1 - ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥/‡∏ñ‡πâ‡∏≠‡∏¢‡∏Ñ‡∏≥‡∏™‡∏≥‡∏ô‡∏ß‡∏ô (1 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)",
      "s6": "‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà 1 - ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ (1 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)",
      "s7": "‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà 2 - ‡∏Ñ‡∏≥‡∏ö‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô (1 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)",
      "s8": "‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà 2 - ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô (8 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)",
      "s9": "‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà 2 - ‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î (3 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)",
      "s10": "‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà 2 - ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô (2 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)",
      "s11": "‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà 2 - ‡∏Å‡∏≤‡∏£‡∏™‡∏∞‡∏Å‡∏î‡∏Ñ‡∏≥/‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤ (2 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)",
      "s12": "‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà 2 - ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥/‡∏ñ‡πâ‡∏≠‡∏¢‡∏Ñ‡∏≥‡∏™‡∏≥‡∏ô‡∏ß‡∏ô (2 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)",
      "s13": "‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà 2 - ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ (2 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)"
    };

    const scoreTableBody = document.getElementById("scoreTableBody");
    Object.entries(scoreMapping).forEach(([key, label]) => {
      scoreTableBody.innerHTML += `
        <tr>
          <td>${label}</td>
          <td><input type="number" step="0.5" name="${key}_t1"></td>
          <td><input type="number" step="0.5" name="${key}_t2"></td>
        </tr>
      `;
    });

    // ‚úÖ Form ‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á
    const form = document.getElementById('answerForm');
    const messageForm = document.getElementById('messageForm');

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());

      data.student_id = parseInt(data.student_id);
      data.exam_year = parseInt(data.exam_year);
      data.status = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à";

      // ‚úÖ ‡∏£‡∏ß‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏£‡∏π 2 ‡∏Ñ‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á
      const scores_t1 = {}, scores_t2 = {};
      Object.entries(scoreMapping).forEach(([key]) => {
        const val_t1 = parseFloat(formData.get(`${key}_t1`));
        const val_t2 = parseFloat(formData.get(`${key}_t2`));
        scores_t1[key] = isNaN(val_t1) ? null : val_t1;
        scores_t2[key] = isNaN(val_t2) ? null : val_t2;
      });
      data.scores_t1 = scores_t1;
      data.scores_t2 = scores_t2;

      try {
        const res = await fetch(`${API_BASE}/api/answers`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const result = await res.json();
        if (!res.ok) throw new Error(result.detail || result.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');

        messageForm.style.color = 'green';
        messageForm.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏£‡∏π‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ';
        form.reset();
      } catch (err) {
        messageForm.style.color = 'red';
        messageForm.textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message;
      }
    });

    // ‚úÖ Form ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå
    const uploadForm = document.getElementById('uploadForm');
    const messageUpload = document.getElementById('messageUpload');

    uploadForm?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(uploadForm);

      try {
        const res = await fetch(`${API_BASE}/api/answers/upload`, {
          method: 'POST',
          body: formData
        });
        const result = await res.json();
        if (!res.ok) throw new Error(result.detail || result.message || '‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');

        messageUpload.style.color = 'green';
        messageUpload.textContent = `‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß ${result.inserted} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
        uploadForm.reset();
      } catch (err) {
        messageUpload.style.color = 'red';
        messageUpload.textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message;
      }
    });
  </script>
</body>
</html>
