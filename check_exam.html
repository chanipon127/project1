<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <title>ระบบตรวจข้อสอบ</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      background-color: #f5f5f5;
    }

    .navbar {
      background-color: #4c65af;
      color: white;
      padding: 10px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .navbar a {
      color: white;
      text-decoration: none;
      margin-right: 20px;
      font-weight: bold;
    }

    .navbar a:hover {
      text-decoration: underline;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .user-info img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
    }

    .container {
      padding: 20px;
    }

    .filters {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }

    select,
    button {
      padding: 5px 10px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      background-color: white;
    }

    th,
    td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
    }

    th {
      background-color: #e0e0e0;
    }

    .status-checked {
      color: green;
      font-weight: bold;
    }

    .status-unchecked {
      color: red;
      font-weight: bold;
    }

    h2 {
      margin-top: 0;
    }
  </style>
</head>

<body>

  <!-- Navbar -->
  <div class="navbar">
    <div class="navbar-left">
      <a href="homepage_user.html">HOME PAGE</a>
      <a href="check_exam.html">ตรวจข้อสอบ</a>
      <a href="profile_user.html">จัดการผู้ใช้งาน</a>
      <a href="contact_admin.html">ติดต่อแอดมิน</a>
      <a href="login.html">ออกจากระบบ</a>
    </div>
    <div class="navbar-right">
      <div class="user-info">
        <div>
          <strong>mr.ja</strong><br>
          <small>ja127</small>
        </div>
        <img src="https://via.placeholder.com/40" alt="User Avatar">
      </div>
    </div>
  </div>

  <!-- Main Container -->
  <div class="container">
    <h2>รายชื่อนักเรียน</h2>

    <div class="filters">
      <label>ปีการศึกษา:
        <select id="year">
          <option value="">-- เลือกปีการศึกษา --</option>
        </select>
      </label>

      <label>กลุ่มการสอบ:
        <select id="group">
          <option value="">-- เลือกกลุ่มการสอบ --</option>
        </select>
      </label>

      <button onclick="loadData()">โหลดข้อมูล</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>รหัสนักเรียน</th>
          <th>ชั้นเรียน</th>
          <th>ปีการศึกษา</th>
          <th>สถานะ</th>
          <th>ผลคะแนน</th>
        </tr>
      </thead>
      <tbody id="studentTableBody"></tbody>
    </table>
  </div>

  <script>
    let allData = []; // เก็บข้อมูลทั้งหมดจาก API

    // โหลดตัวเลือกปี/กลุ่ม
    async function loadFilters() {
      try {
        const res = await fetch("http://127.0.0.1:8000/api/answers-all");
        if (!res.ok) throw new Error("โหลดข้อมูลไม่สำเร็จ");
        allData = await res.json();

        // เก็บข้อมูลดิบไว้ใน sessionStorage
        sessionStorage.setItem("allData", JSON.stringify(allData));

        populateFilters();
        restoreSelectionsAndTable(); // กู้ค่าที่เคยเลือกไว้
      } catch (err) {
        alert("โหลดตัวเลือกปี/กลุ่มไม่สำเร็จ: " + err.message);
      }
    }

    function populateFilters() {
      const years = [...new Set(allData.map(item => item.exam_year))];
      const yearSelect = document.getElementById("year");
      yearSelect.innerHTML = '<option value="">-- เลือกปีการศึกษา --</option>';
      years.forEach(y => {
        const option = document.createElement("option");
        option.value = y;
        option.textContent = y;
        yearSelect.appendChild(option);
      });

      const groups = [...new Set(allData.map(item => item.group_id))];
      const groupSelect = document.getElementById("group");
      groupSelect.innerHTML = '<option value="">-- เลือกกลุ่มการสอบ --</option>';
      groups.forEach(g => {
        const option = document.createElement("option");
        option.value = g;
        option.textContent = g;
        groupSelect.appendChild(option);
      });
    }

    function loadData() {
      const year = document.getElementById("year").value;
      const group = document.getElementById("group").value;

      // เก็บค่าที่เลือกไว้
      sessionStorage.setItem("selectedYear", year);
      sessionStorage.setItem("selectedGroup", group);

      let data = [...allData];
      if (year) data = data.filter(item => String(item.exam_year) === year);
      if (group) data = data.filter(item => String(item.group_id) === group);

      renderTable(data);
    }

    function renderTable(data) {
      const tbody = document.getElementById("studentTableBody");
      tbody.innerHTML = "";

      if (data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5">ไม่พบข้อมูล</td></tr>`;
        return;
      }

      data.forEach(ans => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${ans.student_id}</td>
          <td>${ans.group_id}</td>
          <td>${ans.exam_year}</td>
          <td class="status-col ${ans.status === "ตรวจแล้ว" ? "status-checked" : "status-unchecked"}">
            ${ans.status}
          </td>
          <td>
            ${ans.status === "ตรวจแล้ว"
            ? `<button onclick="viewScore(${ans.answer_id})">ดูผล</button>`
            : `<button onclick="startCheck(${ans.answer_id}, this)">ตรวจ</button>`}
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    async function startCheck(answerId, btn) {
      btn.disabled = true;
      btn.innerText = "กำลังตรวจ...";
      try {
        const res = await fetch(`http://127.0.0.1:8000/api/check-answer/${answerId}`, { method: "POST" });
        const result = await res.json();

        if (res.ok) {

          const statusTd = btn.closest("tr").querySelector(".status-col");
          statusTd.classList.remove("status-unchecked");
          statusTd.classList.add("status-checked");
          statusTd.innerHTML = `<span style="color: green; font-weight:bold;">ตรวจแล้ว</span>`;

          const actionTd = btn.parentElement;
          actionTd.innerHTML = "";
          const viewBtn = document.createElement("button");
          viewBtn.textContent = "ดูผล";
          viewBtn.addEventListener("click", () => viewScore(answerId));
          actionTd.appendChild(viewBtn);

          // อัปเดตข้อมูลใน allData ด้วย
          const updated = allData.find(item => item.answer_id === answerId);
          if (updated) updated.status = "ตรวจแล้ว";
          sessionStorage.setItem("allData", JSON.stringify(allData));

          viewScore(answerId);
        } else {
          alert(result.detail || "ตรวจไม่สำเร็จ");
          btn.disabled = false;
          btn.innerText = "ตรวจ";
        }
      } catch (err) {
        alert("เกิดข้อผิดพลาด: " + err.message);
        btn.disabled = false;
        btn.innerText = "ตรวจ";
      }
    }
    
    function viewScore(answerId) {
      window.location.href = `view_score.html?answer_id=${answerId}`;
    }

    function restoreSelectionsAndTable() {
      const savedYear = sessionStorage.getItem("selectedYear");
      const savedGroup = sessionStorage.getItem("selectedGroup");
      if (savedYear) document.getElementById("year").value = savedYear;
      if (savedGroup) document.getElementById("group").value = savedGroup;

      if (savedYear || savedGroup) {
        loadData();
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      const saved = sessionStorage.getItem("allData");
      if (saved) {
        allData = JSON.parse(saved);
        populateFilters();
        restoreSelectionsAndTable();
      } else {
        loadFilters();
      }
    });
  </script>

</body>

</html>